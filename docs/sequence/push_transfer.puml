' ------------------------------------------------------------------------------
'  Wallet SDK Diagrams
'  Copyright (C) 2025  Relational
'
'  This program is free software: you can redistribute it and/or modify
'  it under the terms of the GNU Affero General Public License as published
'  by the Free Software Foundation, either version 3 of the License, or
'  (at your option) any later version.
'
'  This program is distributed in the hope that it will be useful,
'  but WITHOUT ANY WARRANTY; without even the implied warranty of
'  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'  GNU Affero General Public License for more details.
'
'  You should have received a copy of the GNU Affero General Public License
'  along with this program.  If not, see <https://www.gnu.org/licenses/>.
' ------------------------------------------------------------------------------

@startuml push_transfer
!include ../includes/style.puml

title Wallet SDK - Stable Coin Push Transfer Flow

' --- PARTICIPANTS ---
actor "Retail User\n(Sender)" as retailUser

box "Host Application (Integrated with Wallet SDK)" #EBF5FB
    participant "SDK Client\n(Connector)" as connectorApp
    participant "SDK Core\n(Enclave)" as enclaveServer
    participant "Secure\nStorage" as sealedStorage
end box

participant "Avalanche\nLedger" as ledger

' --- FLOW ---
group #F4F6F7 Phase 1: SDK Initialization
    retailUser -> connectorApp: Login (Username + PIN)
    activate connectorApp

    connectorApp -> enclaveServer: SDK.openWallet()
    activate enclaveServer
    enclaveServer -> sealedStorage: Retrieve sealed wallet blob
    activate sealedStorage
    sealedStorage --> enclaveServer: Sealed data
    deactivate sealedStorage
    enclaveServer -> enclaveServer: Unseal logic
    enclaveServer --> connectorApp: Wallet Instance Ready
    deactivate enclaveServer
    
    connectorApp -> ledger: Fetch Balance
    activate ledger
    ledger --> connectorApp: Current Balance
    deactivate ledger
    
    connectorApp --> retailUser: Dashboard Ready
    deactivate connectorApp
end

group #FEF9E7 Phase 2: Push Payment Execution
    retailUser -> connectorApp: Initiate Push Payment\n(Amount + Dest. Address)
    activate connectorApp
    
    connectorApp -> enclaveServer: SDK.createTx()
    activate enclaveServer
    
    enclaveServer -> sealedStorage: Retrieve Sender's Sealed Blob
    activate sealedStorage
    sealedStorage --> enclaveServer: Sealed data
    deactivate sealedStorage
    
    note right of enclaveServer
      **Secure Operation:**
      Sign transaction using
      unsealed private key
    end note
    
    enclaveServer -> enclaveServer: Sign Transaction
    enclaveServer -> ledger: Broadcast Transaction
    activate ledger
    ledger --> enclaveServer: Success (Tx Hash)
    deactivate ledger
    enclaveServer --> connectorApp: Transaction Successful
    deactivate enclaveServer
    
    connectorApp --> retailUser: Display Success Receipt
    deactivate connectorApp
end
@enduml