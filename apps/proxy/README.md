# Relational Wallet — Nginx Reverse Proxy

Nginx TLS-terminating reverse proxy that sits in front of the rust-server,
providing a valid certificate for external callers (TrueLayer webhooks, etc.).

```
TrueLayer webhook
       ↓ HTTPS (valid cert)
  Nginx (port 443)
       ↓ HTTPS (proxy_ssl_verify off — RA-TLS self-signed)
  rust-server (port 8080)
```

## Quick Start

### 1. Install & bootstrap (self-signed cert)

```bash
sudo bash apps/proxy/scripts/setup.sh
```

This installs Nginx, generates a self-signed bootstrap cert, and starts
proxying `https://localhost:443 → https://127.0.0.1:8080`.

### 2. Get a real Let's Encrypt certificate

```bash
# Get your token from https://www.duckdns.org
sudo DUCKDNS_TOKEN=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
    bash apps/proxy/scripts/get-cert.sh
```

This uses DNS-01 challenge via DuckDNS — no port 80 needed.
Auto-renewal is configured via cron (every 12 hours).

### 3. Verify

```bash
# Proxy health
curl https://relational-wallet.duckdns.org/proxy/health

# Backend passthrough
curl -k https://relational-wallet.duckdns.org/docs
```

## Configuration

### DuckDNS Setup

1. Go to [duckdns.org](https://www.duckdns.org) and sign in
2. Create subdomain: `relational-wallet`
3. Point it to your server's public IP
4. Copy your token for the `get-cert.sh` script

### TrueLayer Console

Once the cert is live, configure the webhook URL in TrueLayer Console:

```
https://relational-wallet.duckdns.org/v1/fiat/providers/truelayer/webhook
```

### Files

| File | Purpose |
|------|---------|
| `nginx.conf` | Main Nginx config (installed to `/etc/nginx/nginx.conf`) |
| `scripts/setup.sh` | Install Nginx + self-signed bootstrap cert |
| `scripts/get-cert.sh` | Obtain Let's Encrypt cert via DuckDNS DNS-01 |
| `certs/` | Local cert storage (gitignored) |

### Nginx Management

```bash
sudo nginx -t                   # Test config
sudo systemctl reload nginx     # Reload after config change
sudo systemctl status nginx     # Check status
sudo tail -f /var/log/nginx/access.log   # Watch requests
sudo tail -f /var/log/nginx/error.log    # Watch errors
```

### Updating Config

After editing `nginx.conf`:

```bash
sudo cp apps/proxy/nginx.conf /etc/nginx/nginx.conf
sudo nginx -t && sudo systemctl reload nginx
```

## Architecture Notes

- **No HTTP fallback**: Port 80 redirects to HTTPS.
- **RA-TLS passthrough**: Nginx connects to the backend via HTTPS but skips
  certificate verification (`proxy_ssl_verify off`) since the rust-server uses
  a self-signed RA-TLS cert generated by Gramine.
- **Rate limiting**: Webhook endpoint is limited to 10 req/s per IP with
  burst=20.
- **Header forwarding**: `X-Real-IP`, `X-Forwarded-For`, `X-Forwarded-Proto`,
  and all `tl-*` headers are passed through to the backend.
